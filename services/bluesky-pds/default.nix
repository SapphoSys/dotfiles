{ config, lib, ... }:

{
  age.secrets.bluesky-pds = {
    file = ../../secrets/bluesky-pds.age;
    owner = "pds";
    group = "pds";
    mode = "600";
  };

  services.bluesky-pds = {
    enable = true;
    pdsadmin.enable = true;
    settings = {
      PDS_HOSTNAME = "pds.sappho.systems";
      PDS_PORT = 3333;
      PDS_CRAWLERS = lib.concatStringsSep "," [
        "https://bsky.network"
        "https://relay.cerulea.blue"
        "https://relay.upcloud.world"
        "https://atproto.africa"
      ];
    };
    environmentFiles = [ config.age.secrets.bluesky-pds.path ];
  };

  services.caddy.virtualHosts."pds.sappho.systems" = {
    serverAliases = [ "*.pds.sappho.systems" ];
    extraConfig = ''
      import common
      import tls_cloudflare

      handle / {
        respond <<EOF
        â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£°â¡€â¢€â €â¢€â €â €â €â €
        â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£°â¢§â¢³â£¾â£‚â£¾â¡â£´â €â €
        â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£°â “â£¬â ¾â ‹â ‰â¢¸â£·â£‹â£¤â¡¦
        â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¯â¡žâ ƒâ €â €â €â¡¼â Šâ£ â¡â €
        â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â¡€â €â €â €â¡€â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¶â£„â£€â£€â¡´â£¡â¡´â ƒâ €â €
        â €â €â €â €â €â €â €â €â €â €â €â €â¡€â €â£½â §â¢´â¡€â¢¸â¡›â €â¡€â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â¡¿â »â ›â ‹â ‰â â €â €â €â €
        â €â €â €â €â €â €â €â €â €â €â €â ¾â¡‡â¢¸â ‰â €â €â ¹â£¼â£½â¡šâ ‰â ¹â¡„â €â €â €â €â €â €â €â €â¡´â ›â ™â¢³â¡€â €â£¿â¡‡â €â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â €â €â €â €â¡˜â¢¿â£†â €â €â €â£¿â ‰â €â €â¢€â£§â €â¢€â£¤â ¤â¢¤â£„â €â¢¸â ‰â €â €â ˆâ£§â¢¸â£¿â â €â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â €â €â¢°â ¾â ‰â ™â »â¢—â €â£¦â£â£¤â €â£ â žâ €â €â£žâ ‹â €â €â ˆâ »â¡¼â¡€â£„â¡€â¢€â¡¯â Ÿâ §â¢¤â¡€â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â €â €â ˜â¢¯â£€â €â €â ²â£·â¡¿â£¿â ‹â ‰â â €â €â €â ¹â£„â €â €â£ â£¤â ˜â §â£½â£¨â£žâ¡â €â €â €â¡‡â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â €â €â €â €â ˆâ ‰â ‰â ‰â â €â¢¸â£·â €â €â €â €â €â €â ˆâ£“â£¦â£œâ ‰â£¿â£¶â §â£Ÿâ£™â£€â£€â£ â žâ â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â €â €â €â €â €â €â¡žâ ‰â €â ¾â žâ¡µâ¢œâ£‡â¡€â ™â¢¦â €â €â €â €â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â €â €â €â €â¢€â¡¤â ¤â ¤â£„â €â£¼â£¿â¡ â ´â ¶â ¦â£„â €â£·â£€â €â¢€â£ â¡·â¡€â ‰â â €â¢¸â ‡â €â €â €â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â €â €â €â£°â¡‹â €â €â €â ˆâ¢·â£¿â ‹â €â €â €â €â¢¸â¡†â €â ˆâ ‰â£©â£¿â £â ™â ²â ¤â ¶â ‹â €â €â €â €â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â €â €â €â¡‡â €â €â €â €â €â €â¢»â €â €â €â €â €â €â¡‡â£ â£´â£¾â Ÿâ â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â €â €â €â¢»â£„â €â €â €â¢ â£¦â£Œâ¡„â¢ â£¦â €â €â£¾â ¹â ‹â ‰â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â €â¢€â¡ â ¤â ™â ¢â¢„â¡€â €â¢³â¡„â¢ƒâ¡¼â ‰â£€â œâ ‹â ‰â ’â¢¦â¡€â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â¢ â¡¯â €â €â €â €â €â£ â¡‰â ™â£¹â£¿â ¶â£®â£â¡€â €â €â €â €â¢»â¡€â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â €â ³â£„â €â €â €â ˜â ›â “â£›â ‡â¢¸â¡·â¡€â »â Ÿâ €â €â €â €â¢¸â£§â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â €â €â €â ˆâ£¹â ’â ¶â¢¶â ’â ‰â €â €â ˆâ ‰â¢«â ³â¢„â£€â£€â£€â¡¤â Ÿâ €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
        â €â €â €â €â €â €â €â¢€â£€â£¤â¡¾â ‹â €â €â¢°â €â €â €â €â €â €â¢¸â£‡â €â ˆâ ‰â â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
        â €â €â €â €â£ â£´â£¾â ¿â ›â â €â €â €â €â ˆâ ³â£„â£€â£€â£€â¡¤â žâ €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
        â €â €â£´â£¿â¡¿â ‰â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
        â €â£¾â¡Ÿâ â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
        â¢¸â¡¿â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
        â ˆâ¢§â¡ƒâ €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €
        â €â ˆâ €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €

      Welcome to Sapphic Angels' AT Protocol Personal Data Server (PDS)

      API routes accessible at /xrpc/

      Website: https://sapphic.moe
      AT Protocol: https://atproto.com
      Self-host your own PDS: https://github.com/bluesky-social/pds

      ðŸŒ¸ ðŸ‡
      EOF 200
      }

      handle {
        reverse_proxy http://127.0.0.1:3333
      }
    '';
  };
}
